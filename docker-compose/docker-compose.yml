version: '3.8'

services:
  # 1. Nginx
  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - certbot-etc:/etc/letsencrypt
      - certbot-www:/usr/share/nginx/html
    networks:
      - app-network
    depends_on:
      - api-server
    restart: always

  # 2. Certbot
  certbot:
    image: certbot/certbot:latest
    container_name: certbot
    volumes:
      - certbot-etc:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    entrypoint: >
      sh -c "while :; do
      certbot renew --webroot -w /var/www/certbot --quiet;
      sleep 12h;
      done"
    depends_on:
      - nginx
    restart: always
    networks:
      - app-network

  # 3. Nginx Reloader
  nginx-reloader:
    image: docker:27-cli
    container_name: nginx-reloader
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - certbot-etc:/etc/letsencrypt:ro
    entrypoint: >
      sh -c 'FILE=/etc/letsencrypt/live/woong2e-prod.com/fullchain.pem;
      PREV="$(cksum "$$FILE" 2>/dev/null || true)";
      while :; do
        CURR="$(cksum "$$FILE" 2>/dev/null || true)";
        if [ "$$CURR" != "$$PREV" ] && [ -n "$$CURR" ]; then
          echo "[reloader] cert changed -> nginx reload";
          docker exec nginx nginx -s reload || true;
          PREV="$$CURR";
        fi;
        sleep 300;
      done'
    depends_on:
      - nginx
    restart: always
    networks:
      - app-network

  # 4. [API] Producer Server
  api-server:
    image: ${DOCKER_HUB_USERNAME}/coupon-api:latest
    restart: always
    deploy:
      replicas: 2
    env_file:
      - .env
    environment:
      - JAVA_TOOL_OPTIONS=-Xms512m -Xmx512m
    ports:
      - "8081-8082:8080"
    networks:
      - app-network

  # 5. [Worker] Consumer Server
  consumer-worker:
    image: ${DOCKER_HUB_USERNAME}/coupon-consumer:latest
    container_name: consumer-worker
    restart: always
    deploy:
      replicas: 1
    env_file:
      - .env
    environment:
      - JAVA_TOOL_OPTIONS=-Xms400m -Xmx400m
    ports:
      - "8083:8081"
    networks:
      - app-network

networks:
  app-network:
    external: true

volumes:
  certbot-etc:
  certbot-www: